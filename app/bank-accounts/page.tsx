'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/app/components/Button'
import Navigation from '@/app/components/Navigation'
import { formatDate, formatCurrency } from '@/lib/utils'
import { toast } from 'sonner'

interface BankAccount {
  id: string
  bank_name: string
  bank_country: string
  account_number: string
  sort_code: string
  login_url: string
  login_username: string
  login_password: string
  pink_cards_limit: number
  created_at: string
  updated_at: string
  cards: Card[]
}

interface Card {
  id: string
  card_number: string
  card_expiry: string
  card_cvv: string
  card_type: 'pink' | 'gray'
  is_active: boolean
  assigned_to?: string
  assigned_site?: string
  times_assigned: number
  times_worked: number
  created_at: string
}

export default function BankAccountsPage() {
  const [bankAccounts, setBankAccounts] = useState<BankAccount[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [userRole, setUserRole] = useState('')
  const [showCreateForm, setShowCreateForm] = useState(false)
  const [formData, setFormData] = useState({
    bank_name: '',
    bank_country: '',
    account_number: '',
    sort_code: '',
    login_url: '',
    login_username: '',
    login_password: ''
  })
  const router = useRouter()

  useEffect(() => {
    const userData = localStorage.getItem('user')
    if (userData) {
      const user = JSON.parse(userData)
      setUserRole(user.role)
      loadBankAccounts()
    } else {
      router.push('/login')
    }
  }, [])

  const loadBankAccounts = async () => {
    try {
      const authToken = localStorage.getItem('auth-token')
      const response = await fetch('/api/bank-accounts', {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      
      if (response.ok) {
        const data = await response.json()
        setBankAccounts(data.bankAccounts || [])
      } else {
        console.error('Failed to load bank accounts')
        toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤')
      }
    } catch (error) {
      console.error('Bank accounts error:', error)
      toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤')
    } finally {
      setIsLoading(false)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    try {
      const authToken = localStorage.getItem('auth-token')
      const response = await fetch('/api/bank-accounts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
          ...formData,
          pink_cards_limit: 5 // –í—Å–µ–≥–¥–∞ 5 –¥–ª—è —Ä–æ–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç
        })
      })

      if (response.ok) {
        toast.success('–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!')
        setShowCreateForm(false)
        setFormData({
          bank_name: '',
          bank_country: '',
          account_number: '',
          sort_code: '',
          login_url: '',
          login_username: '',
          login_password: ''
        })
        loadBankAccounts()
      } else {
        const error = await response.json()
        toast.error(error.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞')
      }
    } catch (error) {
      console.error('Submit error:', error)
      toast.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞')
    }
  }

  const getCardTypeColor = (type: string) => {
    return type === 'pink' ? 'from-pink-500 to-pink-600' : 'from-gray-500 to-gray-600'
  }

  const getCardTypeIcon = (type: string) => {
    return type === 'pink' ? 'ü©∑' : '‚ö´'
  }

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
          <p className="text-white text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤...</p>
        </div>
      </div>
    )
  }

  if (!['Admin', 'CFO'].includes(userRole)) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900">
        <Navigation userRole={userRole} />
        <div className="container mx-auto px-4 py-8">
          <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-8 text-center">
            <div className="text-6xl mb-4">üö´</div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h3>
            <p className="text-gray-600">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ CFO –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</p>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900">
      <Navigation userRole={userRole} />
      
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6 mb-8">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h1>
              <p className="text-gray-600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –∏ –∫–∞—Ä—Ç–∞–º–∏</p>
            </div>
            <div className="flex space-x-4">
              <Button
                onClick={() => setShowCreateForm(true)}
                className="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
              >
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
              </Button>
            </div>
          </div>
        </div>

        {/* Statistics */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6">
            <div className="flex items-center">
              <div className="text-3xl mr-4">üè¶</div>
              <div>
                <p className="text-sm text-gray-600">–í—Å–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>
                <p className="text-2xl font-bold text-gray-900">{bankAccounts.length}</p>
              </div>
            </div>
          </div>
          <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6">
            <div className="flex items-center">
              <div className="text-3xl mr-4">üí≥</div>
              <div>
                <p className="text-sm text-gray-600">–í—Å–µ–≥–æ –∫–∞—Ä—Ç</p>
                <p className="text-2xl font-bold text-gray-900">
                  {bankAccounts.reduce((sum, account) => sum + account.cards.length, 0)}
                </p>
              </div>
            </div>
          </div>
          <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6">
            <div className="flex items-center">
              <div className="text-3xl mr-4">ü©∑</div>
              <div>
                <p className="text-sm text-gray-600">–†–æ–∑–æ–≤—ã–µ –∫–∞—Ä—Ç—ã</p>
                <p className="text-2xl font-bold text-gray-900">
                  {bankAccounts.reduce((sum, account) => 
                    sum + account.cards.filter(card => card.card_type === 'pink').length, 0
                  )}
                </p>
              </div>
            </div>
          </div>
          <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6">
            <div className="flex items-center">
              <div className="text-3xl mr-4">‚ö´</div>
              <div>
                <p className="text-sm text-gray-600">–°–µ—Ä—ã–µ –∫–∞—Ä—Ç—ã</p>
                <p className="text-2xl font-bold text-gray-900">
                  {bankAccounts.reduce((sum, account) => 
                    sum + account.cards.filter(card => card.card_type === 'gray').length, 0
                  )}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Bank Accounts List */}
        <div className="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">–°–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h2>
          
          {bankAccounts.length === 0 ? (
            <div className="text-center py-8">
              <div className="text-6xl mb-4">üè¶</div>
              <p className="text-gray-600">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>
            </div>
          ) : (
            <div className="space-y-6">
              {bankAccounts.map((account) => (
                <div key={account.id} className="border border-gray-200 rounded-xl p-6 bg-gradient-to-r from-blue-50 to-indigo-50">
                  {/* Account Info */}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                      <h3 className="font-semibold text-gray-900 mb-2">üè¶ {account.bank_name}</h3>
                      <p className="text-sm text-gray-600">{account.bank_country}</p>
                      <p className="text-sm text-gray-600">–°—á–µ—Ç: {account.account_number}</p>
                      <p className="text-sm text-gray-600">–°–æ—Ä—Ç: {account.sort_code}</p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">üîó –î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞</h4>
                      <a href={account.login_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 text-sm block">
                        {account.login_url}
                      </a>
                      <p className="text-sm text-gray-600">–õ–æ–≥–∏–Ω: {account.login_username}</p>
                      <p className="text-sm text-gray-600">–ü–∞—Ä–æ–ª—å: {account.login_password}</p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç</h4>
                      <p className="text-sm text-gray-600">
                        –†–æ–∑–æ–≤—ã–µ: {account.cards.filter(c => c.card_type === 'pink').length} / {account.pink_cards_limit}
                      </p>
                      <p className="text-sm text-gray-600">
                        –°–µ—Ä—ã–µ: {account.cards.filter(c => c.card_type === 'gray').length}
                      </p>
                      <p className="text-sm text-gray-600">
                        –í—Å–µ–≥–æ: {account.cards.length}
                      </p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                      <p className="text-sm text-gray-600">–°–æ–∑–¥–∞–Ω: {formatDate(account.created_at)}</p>
                      <p className="text-sm text-gray-600">–û–±–Ω–æ–≤–ª–µ–Ω: {formatDate(account.updated_at)}</p>
                    </div>
                  </div>

                  {/* Cards */}
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-4">üí≥ –ö–∞—Ä—Ç—ã</h4>
                    {account.cards.length === 0 ? (
                      <p className="text-gray-500 text-center py-4">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {account.cards.map((card) => (
                          <div key={card.id} className="bg-white rounded-lg p-4 border border-gray-200">
                            <div className="flex items-center justify-between mb-2">
                              <span className={`inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-gradient-to-r ${getCardTypeColor(card.card_type)} text-white`}>
                                {getCardTypeIcon(card.card_type)} {card.card_type === 'pink' ? '–†–æ–∑–æ–≤–∞—è' : '–°–µ—Ä–∞—è'}
                              </span>
                              <span className={`inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${card.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {card.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}
                              </span>
                            </div>
                            
                            <div className="font-mono text-sm mb-2">
                              <div className="text-gray-900">{card.card_number}</div>
                              <div className="text-gray-500">{card.card_expiry} | {card.card_cvv}</div>
                            </div>
                            
                            <div className="text-xs text-gray-600 space-y-1">
                              <div>–ù–∞–∑–Ω–∞—á–µ–Ω–∞: {card.times_assigned} —Ä–∞–∑</div>
                              <div>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–∞: {card.times_worked} —Ä–∞–∑</div>
                              {card.assigned_to && (
                                <div>–ù–∞–∑–Ω–∞—á–µ–Ω–∞: {card.assigned_to}</div>
                              )}
                              {card.assigned_site && (
                                <div>–°–∞–π—Ç: {card.assigned_site}</div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Create Bank Account Modal */}
      {showCreateForm && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –∞–∫–∫–∞—É–Ω—Ç</h2>
              
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üè¶ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞
                    </label>
                    <input
                      type="text"
                      required
                      value={formData.bank_name}
                      onChange={(e) => setFormData({...formData, bank_name: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üåç –°—Ç—Ä–∞–Ω–∞ –±–∞–Ω–∫–∞
                    </label>
                    <select
                      required
                      value={formData.bank_country}
                      onChange={(e) => setFormData({...formData, bank_country: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                      <option value="UK">üá¨üáß UK</option>
                      <option value="IE">üáÆüá™ IE</option>
                      <option value="DE">üá©üá™ DE</option>
                      <option value="ES">üá™üá∏ ES</option>
                      <option value="FR">üá´üá∑ FR</option>
                      <option value="IT">üáÆüáπ IT</option>
                      <option value="NL">üá≥üá± NL</option>
                      <option value="BE">üáßüá™ BE</option>
                      <option value="AT">üá¶üáπ AT</option>
                      <option value="CH">üá®üá≠ CH</option>
                      <option value="PL">üáµüá± PL</option>
                      <option value="CZ">üá®üáø CZ</option>
                      <option value="HU">üá≠üá∫ HU</option>
                      <option value="RO">üá∑üá¥ RO</option>
                      <option value="BG">üáßüá¨ BG</option>
                      <option value="HR">üá≠üá∑ HR</option>
                      <option value="SI">üá∏üáÆ SI</option>
                      <option value="SK">üá∏üá∞ SK</option>
                      <option value="LT">üá±üáπ LT</option>
                      <option value="LV">üá±üáª LV</option>
                      <option value="EE">üá™üá™ EE</option>
                      <option value="FI">üá´üáÆ FI</option>
                      <option value="SE">üá∏üá™ SE</option>
                      <option value="DK">üá©üá∞ DK</option>
                      <option value="NO">üá≥üá¥ NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üìù –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞
                    </label>
                    <input
                      type="text"
                      required
                      value={formData.account_number}
                      onChange={(e) => setFormData({...formData, account_number: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üî¢ –°–æ—Ä—Ç–æ–≤–æ–π –∫–æ–¥
                    </label>
                    <input
                      type="text"
                      required
                      value={formData.sort_code}
                      onChange={(e) => setFormData({...formData, sort_code: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üîó URL –¥–ª—è –≤—Ö–æ–¥–∞
                    </label>
                    <input
                      type="url"
                      required
                      value={formData.login_url}
                      onChange={(e) => setFormData({...formData, login_url: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üë§ –õ–æ–≥–∏–Ω
                    </label>
                    <input
                      type="text"
                      required
                      value={formData.login_username}
                      onChange={(e) => setFormData({...formData, login_username: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div className="md:col-span-2">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      üîê –ü–∞—Ä–æ–ª—å
                    </label>
                    <input
                      type="password"
                      required
                      value={formData.login_password}
                      onChange={(e) => setFormData({...formData, login_password: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p className="text-sm text-blue-800">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –õ–∏–º–∏—Ç —Ä–æ–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 5 –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω.
                  </p>
                </div>

                <div className="flex justify-end space-x-4">
                  <Button
                    type="button"
                    onClick={() => setShowCreateForm(false)}
                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                  <Button
                    type="submit"
                    className="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-xl"
                  >
                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                  </Button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
